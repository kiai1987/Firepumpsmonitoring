<!-- ✅ READY-TO-PASTE UPGRADED DASHBOARD (NO EXTRA HARDWARE)
     What’s improved vs your version:
     1) NO forced page reload (removed).
     2) Robust MQTT reconnect with exponential backoff + jitter.
     3) Clear separation: mqttConnected vs dataFresh (stale banner).
     4) Fast recovery on return from minimize/lock (visibilitychange + focus).
     5) Failover primary/secondary without thrashing.
     6) Optional “sticky alarms” latch (keeps alarms until Reset).
     7) PWA support hooks (manifest + service worker registration) — add files below.
     
     ⚠️ Important truth:
     Browser can still be suspended in background/lock. This code recovers instantly when resumed.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fire Pump Monitoring Dashboard</title>

  <!-- PWA: add these two files in your repo root (same folder as dashboard.html):
       1) manifest.json
       2) sw.js
       (Templates provided after this HTML)
  -->
  <link rel="manifest" href="manifest.json">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg1:#053c31;
      --bg2:#0a6b54;

      --panel: rgba(16,18,24,.72);
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);

      --text:#eef2ff;
      --muted: rgba(238,242,255,.70);

      --brand:#4aa3ff;
      --ok:#34c759;
      --danger:#ff3b30;
      --warn:#ffcc00;

      --radius:18px;
      --shadow: 0 18px 40px rgba(0,0,0,.35);

      --gap:14px;
      --pad:16px;

      --glow: 0 0 18px rgba(74,163,255,.22);
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      display:none; /* shown after auth */
      min-height: 100dvh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(74,163,255,.18), transparent 55%),
        radial-gradient(900px 500px at 85% 25%, rgba(52,199,89,.14), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
    }

    .page{
      width: min(1180px, 100%);
      margin: 0 auto;
      padding: 14px;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 12px 14px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
      backdrop-filter: blur(14px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
    }

    .logo-side{
      width: 52px;
      height: 52px;
      border-radius: 14px;
      padding: 6px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      object-fit: contain;
    }

    .titles{ min-width:0; }
    .dashboard-title{
      font-size: clamp(16px, 2.4vw, 22px);
      font-weight: 800;
      color: var(--text);
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      white-space: nowrap;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius: 50%;
      background: var(--warn);
      box-shadow: 0 0 14px rgba(255,204,0,.35);
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 14px rgba(52,199,89,.35);
    }
    .dot.bad{
      background: var(--danger);
      box-shadow: 0 0 14px rgba(255,59,48,.35);
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      justify-self:end;
      flex-wrap: wrap;
    }

    .btn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height: 42px;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.18);
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: rgba(74,163,255,.16);
      border-color: rgba(74,163,255,.35);
      box-shadow: var(--glow);
    }
    .btn.danger{
      background: rgba(255,59,48,.20);
      border-color: rgba(255,59,48,.35);
    }

    .content{
      margin-top: 12px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: var(--pad);
      backdrop-filter: blur(14px);
    }

    /* NEW: stale banner */
    .stale-banner{
      margin-bottom: 10px;
      border-radius: 14px;
      padding: 10px 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,204,0,.12);
      color: #fff;
      font-size: 13px;
      font-weight: 900;
      display:none;
      align-items:center;
      justify-content:center;
      gap: 8px;
      text-align:center;
      line-height: 1.25;
    }
    .stale-banner.show{ display:flex; }
    .stale-banner i{ opacity:.9; }

    #alarm-box{
      min-height: 46px;
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: 14px;
      font-weight: 800;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height: 1.25;
      word-break: break-word;
    }
    #alarm-box.alarm{
      background: rgba(255,59,48,.16);
      border-color: rgba(255,59,48,.35);
      color: #fff;
      box-shadow: 0 0 0 2px rgba(255,59,48,.10) inset;
    }
    #alarm-box:empty::before{
      content:"No active alarms (tap once to enable sound)";
    }

    .dashboard{
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
      align-items: stretch;
    }

    .card{
      grid-column: span 4;
      border-radius: 18px;
      padding: 14px;
      background: var(--card);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      position: relative;
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(500px 200px at 0% 0%, rgba(74,163,255,.16), transparent 55%);
      pointer-events:none;
      opacity: .85;
    }
    .card > *{ position: relative; }

    @media (max-width: 1024px){ .card{ grid-column: span 6; } }
    @media (max-width: 680px){
      .page{ padding: 10px; }
      .content{ padding: 12px; }
      .card{ grid-column: span 12; }
      .topbar{
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
      }
      .top-actions{
        grid-column: 1 / -1;
        justify-self: stretch;
        justify-content: space-between;
      }
      .btn{ flex: 1; justify-content: center; }
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
      color: rgba(238,242,255,.90);
      font-size: 13px;
      font-weight: 900;
      letter-spacing: .8px;
      text-transform: uppercase;
    }
    .badge{
      font-size: 11px;
      font-weight: 900;
      color: rgba(238,242,255,.85);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 6px 10px;
    }

    .status-indicators{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .status{
      flex: 1 1 90px;
      min-width: 90px;
      display:grid;
      justify-items:center;
      gap: 7px;
    }
    .status label{
      font-size: 12px;
      font-weight: 800;
      color: rgba(238,242,255,.78);
      letter-spacing: .2px;
    }

    .led{
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 16px rgba(0,0,0,.35);
      transition: filter .2s ease, transform .2s ease;
    }
    .led.led-run{ background: var(--ok); box-shadow: 0 0 20px rgba(52,199,89,.35); }
    .led.led-off{ background: var(--danger); box-shadow: 0 0 20px rgba(255,59,48,.35); }
    .led.led-trip{ background: var(--warn); box-shadow: 0 0 20px rgba(255,204,0,.35); }
    .led.led-alarm{ background: var(--danger); box-shadow: 0 0 20px rgba(255,59,48,.35); }
    .led.led-normal{ background: var(--ok); box-shadow: 0 0 20px rgba(52,199,89,.35); }
    .led.led-blank{ background: rgba(255,255,255,.08); box-shadow: inset 0 0 16px rgba(0,0,0,.35); }

    .controls{
      margin-top: 10px;
      display:flex;
      justify-content:center;
    }
    .control-group{
      width: min(260px, 100%);
      display:grid;
      gap: 6px;
    }
    .control-label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing: .2px;
    }
    .control-input{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 16px; /* prevents iOS zoom */
      outline: none;
    }

    .value{
      font-size: 34px;
      font-weight: 900;
      text-align:center;
      letter-spacing: .2px;
      margin: 10px 0 0;
    }
    .muted{
      color: var(--muted);
      font-weight: 800;
      font-size: 12px;
      text-align:center;
      margin-top: 6px;
    }

    /* Pressure gauge */
    .gauge{
      margin-top: 10px;
      display:grid;
      gap: 10px;
    }
    .gauge-bar{
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      overflow: hidden;
      box-shadow: inset 0 0 14px rgba(0,0,0,.35);
    }
    .gauge-fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(74,163,255,.95), rgba(52,199,89,.95));
      box-shadow: 0 0 18px rgba(74,163,255,.30);
      transition: width .25s ease;
    }
    .gauge-scale{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .footer{
      text-align:center;
      margin-top: 14px;
      font-size: 12px;
      color: rgba(238,242,255,.70);
      font-weight: 700;
    }
    .system-status{
      display:flex;
      justify-content:center;
      margin-top: 10px;
      font-size: 62px;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <img src="https://www.alnakhla.sa/wp-content/uploads/2023/03/new-logo-300x263.png"
             alt="Al Nakhla Logo" class="logo-side">
        <div class="titles">
          <div class="dashboard-title">Fire Pump Monitoring System</div>
          <div class="subtitle">Real-time MQTT status • Al Nakhla Engineering</div>
        </div>
      </div>

      <div class="status-pill" title="Connection state">
        <span class="dot" id="conn-dot"></span>
        <span id="conn-text">Starting…</span>
      </div>

      <div class="top-actions">
        <button class="btn primary" type="button" onclick="acknowledgeAlarm()">
          <i class="fa-solid fa-bell-slash"></i> Acknowledge
        </button>
        <button class="btn" type="button" onclick="resetAlarm()">
          <i class="fa-solid fa-rotate-right"></i> Reset
        </button>
        <button class="btn danger" type="button" onclick="logout()">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>

    <div class="content">
      <!-- NEW: stale-data banner -->
      <div id="stale-banner" class="stale-banner">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span id="stale-text">Data stale</span>
      </div>

      <div id="alarm-box"></div>

      <div class="dashboard">
        <div class="card">
          <div class="card-header">
            <span>Jockey Pump</span>
            <span class="badge">JP</span>
          </div>
          <div class="status-indicators">
            <div class="status"><div class="led" id="jockey-pump-run"></div><label>RUN</label></div>
            <div class="status"><div class="led" id="jockey-pump-off"></div><label>OFF</label></div>
            <div class="status"><div class="led" id="jockey-pump-trip"></div><label>TRIP</label></div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="jockey-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Main Pump</span>
            <span class="badge">MP</span>
          </div>
          <div class="status-indicators">
            <div class="status"><div class="led" id="main-pump-run"></div><label>RUN</label></div>
            <div class="status"><div class="led" id="main-pump-off"></div><label>OFF</label></div>
            <div class="status"><div class="led" id="main-pump-trip"></div><label>TRIP</label></div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="main-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Diesel Pump</span>
            <span class="badge">DP</span>
          </div>
          <div class="status-indicators">
            <div class="status"><div class="led" id="diesel-pump-run"></div><label>RUN</label></div>
            <div class="status"><div class="led" id="diesel-pump-off"></div><label>OFF</label></div>
            <div class="status"><div class="led" id="diesel-pump-trip"></div><label>TRIP</label></div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="diesel-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Room Temp & Humidity</span>
            <span class="badge">TH</span>
          </div>
          <div class="value" id="room-temperature">--°C</div>
          <div class="value" id="room-humidity" style="font-size:28px; margin-top:8px;">--%</div>
          <div class="muted">Auto-sanitized (valid ranges)</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Water Pressure</span>
            <span class="badge">0–16 Bar</span>
          </div>
          <div class="value" id="water-pressure">-- Bar</div>
          <div class="gauge">
            <div class="gauge-bar">
              <div class="gauge-fill" id="pressure-fill"></div>
            </div>
            <div class="gauge-scale">
              <span>0</span><span>8</span><span>16</span>
            </div>
          </div>
          <div class="muted" id="pressure-note">Clamped to sensor range</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Smoke Detector</span>
            <span class="badge">SS1</span>
          </div>
          <div class="status-indicators">
            <div class="status"><div class="led" id="smoke-detector-alarm"></div><label>ALARM</label></div>
            <div class="status"><div class="led" id="smoke-detector-normal"></div><label>NORMAL</label></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Water Flood Sensor</span>
            <span class="badge">FS</span>
          </div>
          <div class="status-indicators">
            <div class="status"><div class="led" id="flood-sensor-alarm"></div><label>ALARM</label></div>
            <div class="status"><div class="led" id="flood-sensor-normal"></div><label>NORMAL</label></div>
          </div>
        </div>
      </div>

      <div class="footer">Created by Al Nakhla Engineering Dep. (Eng. Youssef)</div>
      <div class="system-status">
        <i id="system-status" class="fas fa-check-circle" style="color: var(--ok);"></i>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    /************ GitHub Pages base ************/
    const BASE_URL = "https://kiai1987.github.io/Firepumpsmonitoring/";
    function goTo(page){ window.location.href = BASE_URL + page; }

    /************ PWA install support ************/
    (function registerSW(){
      if (!("serviceWorker" in navigator)) return;
      navigator.serviceWorker.register("sw.js").catch(console.error);
    })();

    /************ Auth ************/
    function checkAuthentication() {
      if (localStorage.getItem("authenticated") !== "true") {
        goTo("index.html");
      } else {
        document.body.style.display = "block";
      }
    }
    function logout() {
      localStorage.removeItem("authenticated");
      localStorage.removeItem("userType");
      goTo("index.html");
    }
    window.addEventListener("load", checkAuthentication);

    /************ Connection badge ************/
    function setConn(stateText, stateClass){
      const dot = document.getElementById("conn-dot");
      const txt = document.getElementById("conn-text");
      txt.textContent = stateText;
      dot.classList.remove("ok","bad");
      if(stateClass) dot.classList.add(stateClass);
    }

    /************ Stale banner ************/
    function setStale(show, text){
      const banner = document.getElementById("stale-banner");
      const label = document.getElementById("stale-text");
      if (!banner || !label) return;
      label.textContent = text || "Data stale";
      banner.classList.toggle("show", !!show);
    }

    /************ Alarm audio (mobile safe) ************/
    let audioContext = null;
    let alarmBuffer = null;
    let alarmSilenced = false;
    let audioUnlocked = false;

    const alarmSoundUrl = BASE_URL + "assets/alarm.wav"; // keep local file

    function initAudioOnce() {
      if (audioUnlocked) return;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioUnlocked = true;

        fetch(alarmSoundUrl)
          .then(r => r.arrayBuffer())
          .then(b => audioContext.decodeAudioData(b))
          .then(buf => { alarmBuffer = buf; })
          .catch(err => console.error("Alarm sound load error:", err));
      } catch (e) {
        console.error("Audio init failed:", e);
      }
    }
    ["pointerdown","touchstart","mousedown","keydown"].forEach(evt=>{
      window.addEventListener(evt, initAudioOnce, {once:true, passive:true});
    });

    function playAlarmSound() {
      if (!audioUnlocked || !audioContext || !alarmBuffer || alarmSilenced) return;
      if (audioContext.state === "suspended") audioContext.resume().catch(()=>{});
      const src = audioContext.createBufferSource();
      src.buffer = alarmBuffer;
      src.connect(audioContext.destination);
      src.start(0);
    }
    function acknowledgeAlarm() {
      alarmSilenced = true;
      if (audioContext && audioContext.state === "running") audioContext.suspend().catch(()=>{});
    }
    function resetAlarm() {
      alarmSilenced = false;
      if (audioContext && audioContext.state === "suspended") audioContext.resume().catch(()=>{});

      // ALSO reset sticky alarm latch
      stickyAlarmLatch = false;
      stickyAlarmMessages = [];
      setAlarmBox("", false);
      setSystemStatus(false);
    }

    /************ UI helpers ************/
    function updateLedStatus(ledId, isActive, className) {
      const el = document.getElementById(ledId);
      if (!el) return;
      el.className = "led";
      el.classList.add(isActive ? className : "led-blank");
    }

    function updateSelector(selectorGroup, mode) {
      const selector = document.getElementById(`${selectorGroup}-mode`);
      if (!selector) return;
      selector.value = String(mode);
    }

    function setSystemStatus(alarmActive) {
      const icon = document.getElementById("system-status");
      if (!icon) return;
      if (alarmActive) {
        icon.classList.remove("fa-check-circle");
        icon.classList.add("fa-exclamation-circle");
        icon.style.color = "var(--danger)";
      } else {
        icon.classList.remove("fa-exclamation-circle");
        icon.classList.add("fa-check-circle");
        icon.style.color = "var(--ok)";
      }
    }

    function setAllLedsBlank() {
      document.querySelectorAll(".led").forEach(led => led.className = "led led-blank");
      document.getElementById("room-temperature").textContent = "--°C";
      document.getElementById("room-humidity").textContent = "--%";
      document.getElementById("water-pressure").textContent = "-- Bar";
      setPressureFill(null);
    }

    /************ Sanitizers ************/
    const PRESSURE_MIN = 0;
    const PRESSURE_MAX = 16;

    function parseNumberAny(v){
      if (v === null || v === undefined) return null;
      if (typeof v === "number") return Number.isFinite(v) ? v : null;
      const s = String(v).trim().replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function sanitizePressure(raw){
      const p = parseNumberAny(raw);
      if (p === null) return {value:null, note:"Invalid"};

      if (p < -1 || p > 1000) return {value:null, note:"Invalid / out of range"};

      const clamped = Math.min(PRESSURE_MAX, Math.max(PRESSURE_MIN, p));
      const note = (clamped !== p) ? `Clamped (${p.toFixed(2)} → ${clamped.toFixed(2)})` : "OK";
      return {value:clamped, note};
    }

    function sanitizeTempHum(thString){
      if (typeof thString !== "string" || !thString.includes(",")) return {t:null, h:null};
      const parts = thString.split(",");
      const t = parseNumberAny(parts[0]);
      const h = parseNumberAny(parts[1]);
      const tOk = (t !== null && t >= -30 && t <= 80) ? t : null;
      const hOk = (h !== null && h >= 0 && h <= 100) ? h : null;
      return {t:tOk, h:hOk};
    }

    function setPressureFill(p){
      const fill = document.getElementById("pressure-fill");
      if (!fill) return;
      if (p === null){
        fill.style.width = "0%";
        return;
      }
      const percent = (p / PRESSURE_MAX) * 100;
      fill.style.width = `${Math.max(0, Math.min(100, percent))}%`;
    }

    /************ Alarm box ************/
    function setAlarmBox(text, isAlarm){
      const box = document.getElementById("alarm-box");
      box.textContent = text || "";
      box.classList.toggle("alarm", !!isAlarm);
    }

    /************ MQTT ************/
    const mqtt_server_primary   = "wss://f2ab9bfaba074ec09d314fd0d5aedfd8.s1.eu.hivemq.cloud:8884/mqtt";
    const mqtt_server_secondary = "wss://279f2d6397444dbcbeb4eaa4897960f7.s1.eu.hivemq.cloud:8884/mqtt";

    const options = {
      username: "firepump",
      password: "044313187Ki@",
      clientId: `mqttjs_${Math.random().toString(16).slice(2,10)}`,
      keepalive: 30,
      connectTimeout: 10000,
      clean: true
      // IMPORTANT: we disable library auto-reconnect; we do our own backoff
      // reconnectPeriod: 0
    };

    let mqttClient = null;
    let activeServer = mqtt_server_primary;

    // Separate states (professional):
    let mqttConnected = false;     // websocket connected to broker
    let lastPayloadTs = 0;         // last status message time

    // Reconnect backoff
    let retryMs = 1000;
    function resetRetry(){ retryMs = 1000; }
    function nextRetry(){
      retryMs = Math.min(60000, Math.floor(retryMs * 1.8 + Math.random() * 600));
      return retryMs;
    }

    // Failover control
    let lastFailoverTs = 0;
    const FAILOVER_COOLDOWN_MS = 15000;

    // Stale thresholds
    const STALE_MS = 15000;     // show stale banner
    const OFFLINE_MS = 60000;   // declare offline/comm fail if no payload for 60s

    // Sticky alarms (client-side latch)
    let stickyAlarmLatch = false;
    let stickyAlarmMessages = [];

    function dataAgeMs(){
      return lastPayloadTs ? (Date.now() - lastPayloadTs) : Infinity;
    }

    function updateConnectivityUI(){
      const age = dataAgeMs();

      // Decide status text
      if (mqttConnected && age <= STALE_MS) {
        setConn("Online", "ok");
        setStale(false, "");
      } else if (mqttConnected && age > STALE_MS && age <= OFFLINE_MS) {
        setConn("Connected (No Data)", "");
        setStale(true, `No data for ${Math.floor(age/1000)}s`);
      } else if (!mqttConnected) {
        setConn("Offline", "bad");
        setStale(true, "Disconnected from broker");
      } else {
        // mqttConnected but very stale
        setConn("Offline (Stale)", "bad");
        setStale(true, `No data for ${Math.floor(age/1000)}s`);
      }
    }

    function connectMqtt(server){
      activeServer = server;

      // Clean previous client
      if (mqttClient) {
        try { mqttClient.removeAllListeners(); mqttClient.end(true); } catch(e){}
        mqttClient = null;
      }

      mqttConnected = false;
      setConn("Connecting…", "");
      updateConnectivityUI();

      mqttClient = mqtt.connect(server, { ...options, reconnectPeriod: 0 });

      mqttClient.on("connect", () => {
        mqttConnected = true;
        resetRetry();
        setConn("Connected", "ok");
        mqttClient.subscribe("fire-pump/status", { qos: 1 }, (err) => {
          if (err) console.error("Subscribe error:", err);
        });
        // If you later add ack topic:
        // mqttClient.subscribe("fire-pump/mode/ack", { qos: 1 });
      });

      mqttClient.on("message", (topic, message) => {
        if (topic !== "fire-pump/status") return;
        try {
          const data = JSON.parse(message.toString());
          lastPayloadTs = Date.now();
          handleStatusUpdates(data);
        } catch (e) {
          console.error("Bad JSON:", e);
        }
      });

      mqttClient.on("error", (err) => {
        console.error("MQTT error:", err);
        // Force close -> our reconnect handler will run on 'close'
        try { mqttClient.end(true); } catch(e){}
      });

      mqttClient.on("close", () => {
        mqttConnected = false;
        updateConnectivityUI();

        // Controlled reconnect with backoff + failover
        const delay = nextRetry();
        setTimeout(() => {
          // alternate server after a few failures or if very stale
          const now = Date.now();
          const shouldFailover = (now - lastFailoverTs) > FAILOVER_COOLDOWN_MS;
          const target = shouldFailover ? failoverServer() : activeServer;
          if (shouldFailover) lastFailoverTs = now;
          connectMqtt(target);
        }, delay);
      });
    }

    function failoverServer(){
      return activeServer === mqtt_server_primary ? mqtt_server_secondary : mqtt_server_primary;
    }

    function showCommFailure(msg) {
      // Keep last visuals; just show banner + alarm (more professional than blanking instantly)
      setAlarmBox(msg, true);
      playAlarmSound();
      setSystemStatus(true);
    }

    function handleStatusUpdates(data) {
      updateConnectivityUI();

      updateLedStatus("jockey-pump-run",  !!data.JP,  "led-run");
      updateLedStatus("jockey-pump-off",  !data.JP,   "led-off");
      updateLedStatus("jockey-pump-trip", !!data.JPT, "led-trip");

      updateLedStatus("main-pump-run",  !!data.MP,  "led-run");
      updateLedStatus("main-pump-off",  !data.MP,   "led-off");
      updateLedStatus("main-pump-trip", !!data.MPT, "led-trip");

      updateLedStatus("diesel-pump-run",  !!data.DP,  "led-run");
      updateLedStatus("diesel-pump-off",  !data.DP,   "led-off");
      updateLedStatus("diesel-pump-trip", !!data.DPT, "led-trip");

      updateLedStatus("smoke-detector-alarm",  !!data.SS1, "led-alarm");
      updateLedStatus("smoke-detector-normal", !data.SS1,  "led-normal");

      updateLedStatus("flood-sensor-alarm",  !!data.FS, "led-alarm");
      updateLedStatus("flood-sensor-normal", !data.FS,  "led-normal");

      const th = sanitizeTempHum(data.TH);
      document.getElementById("room-temperature").textContent = (th.t === null) ? "--°C" : `${th.t.toFixed(1)}°C`;
      document.getElementById("room-humidity").textContent    = (th.h === null) ? "--%"  : `${th.h.toFixed(0)}%`;

      const pr = sanitizePressure(data.WP);
      const pressureNote = document.getElementById("pressure-note");

      if (pr.value === null){
        document.getElementById("water-pressure").textContent = "-- Bar";
        pressureNote.textContent = pr.note;
        setPressureFill(null);
      } else {
        document.getElementById("water-pressure").textContent = `${pr.value.toFixed(2)} Bar`;
        pressureNote.textContent = pr.note;
        setPressureFill(pr.value);
      }

      updateSelector("jockey", data.JPM);
      updateSelector("main", data.MPM);
      updateSelector("diesel", data.DPM);

      // Alarm logic (with sticky latch)
      let alarmMsgs = [];
      let alarmActive = false;

      if (data.JPT) { alarmMsgs.push("Jockey Pump Trip"); alarmActive = true; }
      if (data.MPT) { alarmMsgs.push("Main Pump Trip"); alarmActive = true; }
      if (data.DPT) { alarmMsgs.push("Diesel Pump Trip"); alarmActive = true; }
      if (data.SS1) { alarmMsgs.push("Smoke Detector Alarm"); alarmActive = true; }
      if (data.FS)  { alarmMsgs.push("Water Flood Sensor Alarm"); alarmActive = true; }

      // Pressure invalid warning
      if (pr.value === null && data.WP !== undefined) {
        alarmMsgs.push("Pressure reading invalid");
        alarmActive = true;
      }

      // Optional: comm flags from payload
      if (data.RXTX === false || data.RXMQTT === false) {
        alarmMsgs.push("Communication Failed");
        alarmActive = true;
      }

      // Sticky latch: once alarm active, keep it until Reset pressed
      if (alarmActive) {
        stickyAlarmLatch = true;
        // store unique messages
        alarmMsgs.forEach(m => { if (!stickyAlarmMessages.includes(m)) stickyAlarmMessages.push(m); });
      }

      if (stickyAlarmLatch) {
        setAlarmBox(stickyAlarmMessages.join(" • "), true);
        playAlarmSound();
        setSystemStatus(true);
      } else {
        setAlarmBox("", false);
        setSystemStatus(false);
      }
    }

    /************ OFFLINE / STALE WATCHDOG ************/
    setInterval(() => {
      updateConnectivityUI();

      const age = dataAgeMs();
      // If no payload for OFFLINE_MS, show comm failure and attempt failover reconnect
      if (age > OFFLINE_MS) {
        showCommFailure(`No data for ${Math.floor(age/1000)}s • Checking connection…`);

        // If still connected but no data, bounce connection
        const now = Date.now();
        if ((now - lastFailoverTs) > FAILOVER_COOLDOWN_MS) {
          lastFailoverTs = now;
          connectMqtt(failoverServer());
        } else if (!mqttClient || !mqttClient.connected) {
          connectMqtt(activeServer);
        }
        // Do NOT blank LEDs automatically; keep last known state (professional)
      }
    }, 1000);

    /************ FAST RECOVERY AFTER MINIMIZE / LOCK ************/
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        // If stale or disconnected, reconnect immediately
        if (!mqttClient || !mqttClient.connected || dataAgeMs() > STALE_MS) {
          connectMqtt(activeServer);
        }
      }
    });
    window.addEventListener("focus", () => {
      if (!mqttClient || !mqttClient.connected || dataAgeMs() > STALE_MS) {
        connectMqtt(activeServer);
      }
    });

    /************ Publish mode changes (QoS 1) ************/
    document.addEventListener("change", (e) => {
      const target = e.target;
      if (!target.classList || !target.classList.contains("control-input")) return;
      if (!mqttClient || !mqttClient.connected) return;

      const selectorGroup = target.id.split("-")[0];
      const selectedMode = target.value;

      // Recommended topic naming: fire-pump/mode/set
      const payload = JSON.stringify({ group: selectorGroup, mode: selectedMode, ts: Date.now() });

      mqttClient.publish("fire-pump/mode", payload, { qos: 1 }, (err) => {
        if (err) console.error("Publish error:", err);
      });
    });

    /************ Start ************/
    setConn("Starting…", "");
    connectMqtt(mqtt_server_primary);
  </script>
</body>
</html>
