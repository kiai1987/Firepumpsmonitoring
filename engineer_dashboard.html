<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Fire Pump Monitoring Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg: #005f46;
      --panel: #282828;
      --card: #3b3b3b;
      --text: #e0e0e0;
      --muted: #bdbdbd;
      --brand: #007bff;
      --danger: #ff3b30;
      --warn: #ffcc00;
      --ok: #34c759;

      --radius: 16px;
      --shadow: 0 10px 20px rgba(0,0,0,.25);

      --gap: 14px;
      --pad: 16px;

      --topbar-h: 76px;
    }

    *{ box-sizing: border-box; }
    html, body{ height: 100%; }

    body{
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: none;               /* shown after auth */
      min-height: 100dvh;          /* fixes phone 100vh bugs */
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .page{
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 14px;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(40,40,40,.92);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      min-height: var(--topbar-h);
    }

    .brand{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .logo-side{
      width: 54px;
      height: auto;
      flex: 0 0 auto;
    }

    .titles{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .dashboard-title{
      font-size: clamp(16px, 2.6vw, 22px);
      font-weight: 700;
      color: var(--brand);
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 0 5px rgba(0,123,255,.35);
    }

    .subtitle{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .top-actions{
      display: flex;
      align-items: center;
      gap: 10px;
      justify-self: end;
      flex-wrap: wrap;
    }

    .btn{
      appearance: none;
      border: 0;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      background: var(--brand);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 42px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ filter: brightness(.95); }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn.danger{
      background: rgba(255,59,48,.92);
    }

    .content{
      margin-top: 12px;
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.06);
      padding: var(--pad);
    }

    #alarm-box{
      background: rgba(255,87,34,.95);
      color: #fff;
      padding: 12px 12px;
      border-radius: 12px;
      text-align: center;
      font-size: 16px;
      font-weight: 900;
      text-shadow: 0 0 5px rgba(255,87,34,.55);
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      line-height: 1.25;
      word-break: break-word;
    }
    #alarm-box:empty{
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-weight: 700;
      text-shadow: none;
    }
    #alarm-box:empty::before{
      content: "No active alarms (tap once to enable sound)";
    }

    .dashboard{
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
      align-items: stretch;
    }

    .card{
      grid-column: span 4;
      background: var(--card);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.06);
      position: relative;
      min-width: 0;
    }

    @media (max-width: 1024px){
      .card{ grid-column: span 6; }
    }
    @media (max-width: 680px){
      .page{ padding: 10px; }
      .content{ padding: 12px; }
      .card{ grid-column: span 12; }
      .topbar{
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
      }
      .top-actions{
        grid-column: 1 / -1;
        justify-self: stretch;
        justify-content: space-between;
      }
      .btn{ flex: 1; justify-content: center; }
    }

    .card-header{
      font-size: 14px;
      font-weight: 900;
      color: var(--brand);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }

    .status-indicators{
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .status{
      display: grid;
      justify-items: center;
      gap: 6px;
      flex: 1 1 80px;
      min-width: 80px;
    }

    .led{
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.35);
      background: #2f2f2f;
      box-shadow: inset 0 0 10px rgba(0,0,0,.25);
    }
    .led-run{ background: var(--ok); }
    .led-off{ background: var(--danger); }
    .led-trip{ background: var(--warn); }
    .led-alarm{ background: var(--danger); }
    .led-normal{ background: var(--ok); }
    .led-blank{ background: #333; }

    .controls{
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: 8px;
    }

    .control-group{
      width: min(220px, 100%);
      display: grid;
      gap: 6px;
    }

    .control-label{
      font-size: 13px;
      color: var(--muted);
      font-weight: 800;
      text-align: left;
    }

    .control-input{
      width: 100%;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 10px;
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size: 16px; /* prevents iOS zoom */
      text-align: left;
      outline: none;
    }

    .value{
      font-size: 34px;
      font-weight: 950;
      text-align: center;
      letter-spacing: .5px;
      padding: 10px 0 2px;
    }

    .temperature-humidity{
      display: grid;
      gap: 10px;
      padding-top: 6px;
    }
    .temperature-humidity .value{
      font-size: 30px;
      padding: 0;
    }

    .alarm-icon{
      position: absolute;
      top: 12px;
      right: 12px;
      color: rgba(255,87,34,.95);
      font-size: 22px;
    }
    .hidden{ display: none !important; }

    .footer{
      text-align: center;
      margin-top: 14px;
      font-size: 13px;
      color: rgba(255,255,255,.75);
    }

    .system-status{
      display: flex;
      justify-content: center;
      margin-top: 8px;
      font-size: 64px;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="brand">
        <img src="https://www.alnakhla.sa/wp-content/uploads/2023/03/new-logo-300x263.png"
             alt="Al Nakhla Logo" class="logo-side">
        <div class="titles">
          <div class="dashboard-title">Fire Pump Monitoring System</div>
          <div class="subtitle">Real-time MQTT status • Al Nakhla Engineering</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="btn secondary" id="acknowledge-button" type="button" onclick="acknowledgeAlarm()">
          <i class="fa-solid fa-bell-slash"></i> Acknowledge
        </button>
        <button class="btn secondary" id="reset-button" type="button" onclick="resetAlarm()">
          <i class="fa-solid fa-rotate-right"></i> Reset
        </button>
        <button class="btn danger" type="button" onclick="logout()">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>

    <div class="content">
      <div id="alarm-box"></div>

      <div class="dashboard">
        <div class="card">
          <div class="card-header">Jockey Pump</div>
          <div class="status-indicators">
            <div class="status">
              <div class="led" id="jockey-pump-run"></div>
              <div>RUN</div>
            </div>
            <div class="status">
              <div class="led" id="jockey-pump-off"></div>
              <div>OFF</div>
            </div>
            <div class="status">
              <div class="led" id="jockey-pump-trip"></div>
              <div>TRIP</div>
            </div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="jockey-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
          <i class="fas fa-exclamation-triangle alarm-icon hidden" id="jockey-alarm"></i>
        </div>

        <div class="card">
          <div class="card-header">Main Pump</div>
          <div class="status-indicators">
            <div class="status">
              <div class="led" id="main-pump-run"></div>
              <div>RUN</div>
            </div>
            <div class="status">
              <div class="led" id="main-pump-off"></div>
              <div>OFF</div>
            </div>
            <div class="status">
              <div class="led" id="main-pump-trip"></div>
              <div>TRIP</div>
            </div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="main-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
          <i class="fas fa-exclamation-triangle alarm-icon hidden" id="main-alarm"></i>
        </div>

        <div class="card">
          <div class="card-header">Diesel Pump</div>
          <div class="status-indicators">
            <div class="status">
              <div class="led" id="diesel-pump-run"></div>
              <div>RUN</div>
            </div>
            <div class="status">
              <div class="led" id="diesel-pump-off"></div>
              <div>OFF</div>
            </div>
            <div class="status">
              <div class="led" id="diesel-pump-trip"></div>
              <div>TRIP</div>
            </div>
          </div>
          <div class="controls">
            <div class="control-group">
              <div class="control-label">Mode</div>
              <select class="control-input" id="diesel-mode">
                <option value="0">Off</option>
                <option value="1">Manual</option>
                <option value="2">Auto</option>
              </select>
            </div>
          </div>
          <i class="fas fa-exclamation-triangle alarm-icon hidden" id="diesel-alarm"></i>
        </div>

        <div class="card">
          <div class="card-header">Room Temperature & Humidity</div>
          <div class="temperature-humidity">
            <div class="value" id="room-temperature">--°C</div>
            <div class="value" id="room-humidity">--%</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Water Pressure</div>
          <div class="value" id="water-pressure">0 Bar</div>
        </div>

        <div class="card">
          <div class="card-header">Smoke Detector</div>
          <div class="status-indicators">
            <div class="status">
              <div class="led" id="smoke-detector-alarm"></div>
              <div>ALARM</div>
            </div>
            <div class="status">
              <div class="led" id="smoke-detector-normal"></div>
              <div>NORMAL</div>
            </div>
          </div>
          <i class="fas fa-exclamation-triangle alarm-icon hidden" id="smoke-detector-alarm-icon"></i>
        </div>

        <div class="card">
          <div class="card-header">Water Flood Sensor</div>
          <div class="status-indicators">
            <div class="status">
              <div class="led" id="flood-sensor-alarm"></div>
              <div>ALARM</div>
            </div>
            <div class="status">
              <div class="led" id="flood-sensor-normal"></div>
              <div>NORMAL</div>
            </div>
          </div>
          <i class="fas fa-exclamation-triangle alarm-icon hidden" id="flood-sensor-alarm-icon"></i>
        </div>
      </div>

      <div class="footer">Created by Al Nakhla Engineering Dep. (Eng. Youssef)</div>
      <div class="system-status">
        <i id="system-status" class="fas fa-check-circle" style="color: var(--ok);"></i>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    /************ GitHub Pages base ************/
    const BASE_URL = "https://kiai1987.github.io/Firepumpsmonitoring/";
    function goTo(page){ window.location.href = BASE_URL + page; }

    /************ Auth ************/
    function checkAuthentication() {
      if (localStorage.getItem("authenticated") !== "true") {
        // If your login page is NOT index.html, change this filename
        goTo("index.html");
      } else {
        document.body.style.display = "block";
      }
    }
    function logout() {
      localStorage.removeItem("authenticated");
      localStorage.removeItem("userType");
      goTo("index.html");
    }
    window.addEventListener("load", checkAuthentication);

    /************ Alarm audio (mobile safe) ************/
    let audioContext = null;
    let alarmBuffer = null;
    let alarmSilenced = false;
    let audioUnlocked = false;

    // Recommended: host the wav in your repo as /assets/alarm.wav
    // Put it here: Firepumpsmonitoring/assets/alarm.wav
    const alarmSoundUrl = BASE_URL + "assets/alarm.wav"; // fallback if file exists
    // If you don't have the file, use your old link:
    // const alarmSoundUrl = "https://alarmclock1987.s3.eu-north-1.amazonaws.com/alarm_clock+.wav";

    function initAudioOnce() {
      if (audioUnlocked) return;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioUnlocked = true;

        fetch(alarmSoundUrl)
          .then(r => r.arrayBuffer())
          .then(b => audioContext.decodeAudioData(b))
          .then(buf => { alarmBuffer = buf; })
          .catch(err => console.error("Alarm sound load error:", err));
      } catch (e) {
        console.error("Audio init failed:", e);
      }
    }

    ["pointerdown", "touchstart", "mousedown", "keydown"].forEach(evt => {
      window.addEventListener(evt, initAudioOnce, { once: true, passive: true });
    });

    function playAlarmSound() {
      if (!audioUnlocked || !audioContext || !alarmBuffer || alarmSilenced) return;
      if (audioContext.state === "suspended") audioContext.resume().catch(()=>{});
      const src = audioContext.createBufferSource();
      src.buffer = alarmBuffer;
      src.connect(audioContext.destination);
      src.start(0);
    }

    function acknowledgeAlarm() {
      alarmSilenced = true;
      if (audioContext && audioContext.state === "running") audioContext.suspend().catch(()=>{});
    }

    function resetAlarm() {
      alarmSilenced = false;
      if (audioContext && audioContext.state === "suspended") audioContext.resume().catch(()=>{});
    }

    /************ UI helpers ************/
    function updateLedStatus(ledId, isActive, className) {
      const el = document.getElementById(ledId);
      if (!el) return;
      el.className = "led";
      el.classList.add(isActive ? className : "led-blank");
    }

    function updateSelector(selectorGroup, mode) {
      const selector = document.getElementById(`${selectorGroup}-mode`);
      if (!selector) return;
      selector.value = String(mode);
    }

    function setSystemStatus(alarmActive) {
      const icon = document.getElementById("system-status");
      if (!icon) return;
      if (alarmActive) {
        icon.classList.remove("fa-check-circle");
        icon.classList.add("fa-exclamation-circle");
        icon.style.color = "var(--danger)";
      } else {
        icon.classList.remove("fa-exclamation-circle");
        icon.classList.add("fa-check-circle");
        icon.style.color = "var(--ok)";
      }
    }

    function setAllLedsBlank() {
      document.querySelectorAll(".led").forEach(led => led.className = "led led-blank");
      document.getElementById("room-temperature").textContent = "--°C";
      document.getElementById("room-humidity").textContent = "--%";
      document.getElementById("water-pressure").textContent = "0 Bar";
    }

    /************ MQTT ************/
    const mqtt_server_primary   = "wss://f2ab9bfaba074ec09d314fd0d5aedfd8.s1.eu.hivemq.cloud:8884/mqtt";
    const mqtt_server_secondary = "wss://279f2d6397444dbcbeb4eaa4897960f7.s1.eu.hivemq.cloud:8884/mqtt";

    // WARNING: Credentials in frontend are visible to public
    const options = {
      username: "firepump",
      password: "044313187Ki@",
      clientId: `mqttjs_${Math.random().toString(16).slice(2, 10)}`,
      keepalive: 30,
      reconnectPeriod: 2000,
      connectTimeout: 10000,
      clean: true
    };

    let mqttClient = null;
    let lastMessageTime = Date.now();
    let isConnected = false;
    let activeServer = mqtt_server_primary;

    function handleStatusUpdates(data) {
      lastMessageTime = Date.now();
      isConnected = true;

      updateLedStatus("jockey-pump-run",  !!data.JP,  "led-run");
      updateLedStatus("jockey-pump-off",  !data.JP,   "led-off");
      updateLedStatus("jockey-pump-trip", !!data.JPT, "led-trip");

      updateLedStatus("main-pump-run",  !!data.MP,  "led-run");
      updateLedStatus("main-pump-off",  !data.MP,   "led-off");
      updateLedStatus("main-pump-trip", !!data.MPT, "led-trip");

      updateLedStatus("diesel-pump-run",  !!data.DP,  "led-run");
      updateLedStatus("diesel-pump-off",  !data.DP,   "led-off");
      updateLedStatus("diesel-pump-trip", !!data.DPT, "led-trip");

      updateLedStatus("smoke-detector-alarm",  !!data.SS1, "led-alarm");
      updateLedStatus("smoke-detector-normal", !data.SS1,  "led-normal");

      updateLedStatus("flood-sensor-alarm",  !!data.FS, "led-alarm");
      updateLedStatus("flood-sensor-normal", !data.FS,  "led-normal");

      // TH expected "temp,hum"
      if (typeof data.TH === "string" && data.TH.includes(",")) {
        const [t, h] = data.TH.split(",");
        document.getElementById("room-temperature").textContent = `${t}°C`;
        document.getElementById("room-humidity").textContent = `${h}%`;
      } else {
        document.getElementById("room-temperature").textContent = "--°C";
        document.getElementById("room-humidity").textContent = "--%";
      }

      document.getElementById("water-pressure").textContent =
        (data.WP !== undefined && data.WP !== null) ? `${data.WP} Bar` : "0 Bar";

      updateSelector("jockey", data.JPM);
      updateSelector("main", data.MPM);
      updateSelector("diesel", data.DPM);

      const alarmBox = document.getElementById("alarm-box");
      let alarmMsgs = [];
      let alarmActive = false;

      if (data.JPT) { alarmMsgs.push("Jockey Pump Trip"); alarmActive = true; }
      if (data.MPT) { alarmMsgs.push("Main Pump Trip"); alarmActive = true; }
      if (data.DPT) { alarmMsgs.push("Diesel Pump Trip"); alarmActive = true; }
      if (data.SS1) { alarmMsgs.push("Smoke Detector Alarm"); alarmActive = true; }
      if (data.FS)  { alarmMsgs.push("Water Flood Sensor Alarm"); alarmActive = true; }

      // Communication flags
      if (data.RXTX === false || data.RXMQTT === false) {
        alarmMsgs.push("Communication Failed");
        alarmActive = true;
        setAllLedsBlank();
      }

      alarmBox.textContent = alarmMsgs.join(" • ");
      if (alarmActive) playAlarmSound();
      setSystemStatus(alarmActive);
    }

    function connectMqtt(server) {
      activeServer = server;

      if (mqttClient) {
        try { mqttClient.end(true); } catch(e){}
        mqttClient = null;
      }

      mqttClient = mqtt.connect(server, options);

      mqttClient.on("connect", () => {
        isConnected = true;
        mqttClient.subscribe("fire-pump/status", (err) => {
          if (err) console.error("Subscribe error:", err);
        });
      });

      mqttClient.on("message", (topic, message) => {
        if (topic !== "fire-pump/status") return;
        try {
          const data = JSON.parse(message.toString());
          handleStatusUpdates(data);
        } catch (e) {
          console.error("Bad JSON:", e);
        }
      });

      mqttClient.on("error", (err) => {
        console.error("MQTT error:", err);
        isConnected = false;
      });

      mqttClient.on("close", () => {
        isConnected = false;
      });
    }

    function showCommFailure(msg) {
      const alarmBox = document.getElementById("alarm-box");
      alarmBox.textContent = msg;
      setAllLedsBlank();
      playAlarmSound();
      setSystemStatus(true);
    }

    // Failover if no data for 60s
    setInterval(() => {
      const elapsed = Date.now() - lastMessageTime;
      if (elapsed <= 60000) return;

      if (isConnected) {
        showCommFailure("Receiver-Transmitter Communication Failed");
      } else {
        showCommFailure("Receiver-MQTT Communication Failed");
      }

      if (activeServer === mqtt_server_primary) {
        connectMqtt(mqtt_server_secondary);
      } else {
        connectMqtt(mqtt_server_primary);
      }

      lastMessageTime = Date.now();
    }, 1000);

    // Publish mode changes
    document.addEventListener("change", (e) => {
      const target = e.target;
      if (!target.classList || !target.classList.contains("control-input")) return;
      if (!mqttClient || !mqttClient.connected) return;

      const selectorGroup = target.id.split("-")[0];
      const selectedMode = target.value;
      const payload = JSON.stringify({ group: selectorGroup, mode: selectedMode });

      mqttClient.publish("fire-pump/mode", payload, (err) => {
        if (err) console.error("Publish error:", err);
      });
    });

    // Optional: refresh every 30 minutes (lighter than 10 minutes for phones)
    setInterval(() => location.reload(), 30 * 60 * 1000);

    // Start
    connectMqtt(mqtt_server_primary);
  </script>
</body>
</html>
